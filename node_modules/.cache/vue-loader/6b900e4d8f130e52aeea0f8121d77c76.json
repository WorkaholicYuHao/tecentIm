{"remainingRequest":"/Users/yuhao/TIMSDK/H5/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuhao/TIMSDK/H5/src/components/group-live/components/live-chat.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuhao/TIMSDK/H5/src/components/group-live/components/live-chat.vue","mtime":1616982605599},{"path":"/Users/yuhao/TIMSDK/H5/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuhao/TIMSDK/H5/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuhao/TIMSDK/H5/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/yuhao/TIMSDK/H5/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuhao/TIMSDK/H5/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapState } from 'vuex'\nimport { Tooltip } from 'element-ui'\nimport liveGift from './live-gift'\n\nexport default {\n  name: 'liveChat',\n  data() {\n    return {\n      sendAvailable: false,\n      messageContent: '',\n      defaultAvatar: 'https://imgcache.qq.com/open/qcloud/video/act/webim-avatar/avatar-2.png',\n      giftInfo: [\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590482989_25.png',\n          name: '火箭'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1507876726_3',\n          name: '鸡蛋'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590482294_7.png',\n          name: '吻'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590482461_11.png',\n          name: '跑车'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1594714453_7.png',\n          name: '嘉年华'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590482754_17.png',\n          name: '玫瑰'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1594281297_11.png',\n          name: '直升机'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1507876472_1',\n          name: '点赞'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483038_27.png',\n          name: '比心'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483168_31.png',\n          name: '冰淇淋'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483225_33.png',\n          name: '玩偶'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483278_35.png',\n          name: '蛋糕'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483348_37.png',\n          name: '豪华轿车'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483429_39.png',\n          name: '游艇'\n        },\n        {\n          icon: 'https://8.url.cn/huayang/resource/now/new_gift/1590483505_41.png',\n          name: '翅膀'\n        }\n      ]\n    }\n  },\n  computed: {\n    ...mapState({\n      user: state => state.user,\n      groupLiveInfo: state => state.groupLive.groupLiveInfo,\n      avChatRoomMessageList: state => {\n        const list = state.groupLive.avChatRoomMessageList\n        list.map((item) => {\n          if (item.type === 'TIMCustomElem' && typeof item.payload.data === 'string' && item.payload.data.indexOf('{') > -1) {\n            item.payload.data = JSON.parse(item.payload.data)\n          }\n          return item\n        })\n        return list\n      },\n      // avChatRoomBarrageMessageList: state => state.groupLive.avChatRoomBarrageMessageList,\n      // avChatRoomGiftMessageList: state => state.groupLive.avChatRoomGiftMessageList,\n    }),\n    isAnchor () {\n      return this.user.userID === this.groupLiveInfo.anchorID\n    }\n  },\n  components: {\n    liveGift,\n    ElTooltip: Tooltip,\n  },\n  created() {\n    // 此处监听，防止观众侧派发加群事件时，该组件中还未注册监听\n    this.$bus.$on('join-group-live-avchatroom', () => {\n      this.joinGroupLiveAvChatRoom()\n    })\n  },\n  mounted() {\n    this.$bus.$on('group-live-send-gift', (index)=> {\n      const message = this.tim.createCustomMessage({\n        to: this.groupLiveInfo.roomID,\n        conversationType: this.TIM.TYPES.CONV_GROUP,\n        payload: {\n          data: JSON.stringify({version: '1.0.0' ,'message': `${index}`,'command':'6','action':301}),\n          description: '',\n          extension: ''\n        }\n      })\n      // 此处用JSON序列化和反序列化对message断链\n      this.$store.commit('pushAvChatRoomMessageList', JSON.parse(JSON.stringify(message)))\n      this.tim.sendMessage(message).catch(error => {\n        this.$store.commit('showMessage', {\n          type: 'error',\n          message: error.message\n        })\n      })\n    })\n  },\n  beforeDestroy() {\n    this.$bus.$off('join-group-live-avchatroom')\n    this.$bus.$off('group-live-send-gift')\n    if (!this.isAnchor && this.groupLiveInfo.isNeededQuitRoom === 1) {\n      this.quitGroupLiveAvChatRoom()\n    }\n    this.$store.commit('updateGroupLiveInfo', { isNeededQuitRoom: 0 })\n  },\n  methods: {\n    getAvatar (item) {\n      if (item.from === this.user.userID) {\n        return this.user.currentUserProfile.avatar || this.defaultAvatar\n      }\n      return item.avatar || this.defaultAvatar\n    },\n    getNick (item) {\n      if (item.from === this.user.userID) {\n        return this.user.currentUserProfile.nick || item.from\n      }\n      return item.nick || item.from\n    },\n    // 进入直播互动群\n    joinGroupLiveAvChatRoom() {\n      this.tim.joinGroup({\n        groupID: this.groupLiveInfo.roomID\n      }).then((imResponse) => {\n        const status = imResponse.data.status\n        if (status === this.TIM.TYPES.JOIN_STATUS_SUCCESS || status === this.TIM.TYPES.JOIN_STATUS_ALREADY_IN_GROUP) {\n          this.sendAvailable = true\n        }\n      }).catch(() => {})\n    },\n    // 退出直播互动群\n    quitGroupLiveAvChatRoom() {\n      this.tim.quitGroup(this.groupLiveInfo.roomID).then(() => {}).catch(() => {})\n    },\n    sendMessage() {\n      if (!this.sendAvailable) {\n        this.$store.commit('showMessage', {\n          message: '开始直播后可以互动聊天哦！',\n          type: 'warning'\n        })\n        return\n      }\n      if (this.messageContent === '' || this.messageContent.trim().length === 0) {\n        this.messageContent = ''\n        this.$store.commit('showMessage', {\n          message: '不能发送空消息哦！',\n          type: 'info'\n        })\n        return\n      }\n      const message = this.tim.createTextMessage({\n        to: this.groupLiveInfo.roomID,\n        conversationType: this.TIM.TYPES.CONV_GROUP,\n        payload: { text: this.messageContent }\n      })\n      // 此处用JSON序列化和反序列化对message断链\n      this.$store.commit('pushAvChatRoomMessageList', JSON.parse(JSON.stringify(message)))\n      this.tim.sendMessage(message).catch(error => {\n        this.$store.commit('showMessage', {\n          type: 'error',\n          message: error.message\n        })\n      })\n      this.messageContent = ''\n    }\n  },\n  watch: {\n    avChatRoomMessageList: function() {\n      this.$nextTick(() => {\n        let messageListNode = this.$refs['message-list']\n        if (!messageListNode) {\n          return\n        }\n        messageListNode.scrollTop = messageListNode.scrollHeight\n      })\n    }\n  }\n}\n",null]}